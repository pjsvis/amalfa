# Agent-First Metadata: Auto-Augmentation Patterns

**Status:** Design Document  
**Date:** 2026-01-06  
**Context:** Agent autonomy with human audit model

---

## Executive Summary

Traditional metadata management is a human bottleneck. We propose an **Agent-First** system where agents automatically tag, link, and organize content. Humans shift from "approvers" to "auditors," reviewing automated git commits rather than manual inputs.

**Key Innovation:** **Latent Space Tagging**—tags emerge from vector analysis, not a predefined taxonomy.

---

## Core Principles

### 1. Agent Autonomy, Human Audit
*   **Old:** Agent asks "Can I tag this?" → Human Approves. (Bottleneck)
*   **New:** Agent tags/links automatically. → Human reverts via Git if wrong. (Scalable)

### 2. Git as Source of Truth
All augmentations are atomic, reversible git commits.
*   `Amalfa: auto-tagged debrief-auth.md`
*   `Amalfa: re-clustered corpus`

### 3. Optimistic Metadata
Metadata is applied immediately based on high-confidence inference. It is corrected optimistically (later, if ever).

### 4. Latent Space Organization
We do not maintain a strict taxonomy.
*   **Explicit Tags:** Added by humans (e.g., `client:acme`).
*   **Latent Tags:** Emergent from clusters (e.g., `latent:auth-patterns (0.91)`).

---

## The Auto-Augmentation Workflow

**Trigger:** On file save or pre-commit.

### 1. Analysis Pipeline
1.  **Entity Extraction:** Identify concepts (e.g., "Alpine.js", "Vector DB").
2.  **Auto-Linking:** Link concepts to Playbooks/Debriefs (`[[playbook-alpine]]`).
3.  **Clustering (HDBSCAN):** Assign document to semantic clusters.
4.  **Tagging:** Generate weighted tags based on content and cluster label.

### 2. Output (Front Matter)
The agent injects this block into the document header:

```yaml
---
# Auto-generated by Amalfa
tags:
  explicit: [alpine.js]
  latent:
    - auth-state-patterns (0.91)
    - ui-reactivity (0.78)
links:
  - playbook-alpine-patterns (uses-pattern, 0.89)
suggested_reading:
  - debrief-session-management (0.87)
vector_id: vec_a7f3d2e
last_indexed: 2026-01-05T14:45:00Z
---
```

### 3. Output (Body)
The agent aggressively wikilinks concepts in the text:
*   *Before:* "Alpine's x-data pattern works well."
*   *After:* "[[playbook-alpine-patterns|Alpine's x-data pattern]] works well."

---

## The Pattern Library

### Pattern 1: Latent Space Tagging
*   **Goal:** Organize without taxonomy.
*   **Method:** Cluster vectors -> Label Cluster -> Assign Doc to Cluster -> Tag Doc with Label.

### Pattern 2: Semantic Backlinks
*   **Goal:** automatic bidirectional linking.
*   **Method:** If Doc A links to Doc B, Daemon updates Doc B's frontmatter with `backlinks: [Doc A]`.

### Pattern 3: Similarity Suggestions
*   **Goal:** Context for agents.
*   **Method:** On creating a new Brief, automatically inject `suggested_reading` based on finding the k-nearest neighbors of the Brief's content.

### Pattern 4: Confidence Scoring
All auto-tags have a confidence score (0.0 - 1.0).
*   **Query:** `tags:token-refresh (confidence > 0.8)`
*   **Learning:** If a human removes a tag with confidence 0.45, the system learns to raise its threshold to 0.55.

---

## Human Audit Workflow

1.  **Weekly Review:** `git log --grep="Amalfa:"`
2.  **Correction:** Edit the file manually.
    *   *Action:* User removes `tags: [token-refresh]`.
    *   *System Reaction:* Daemon detects edit, re-indexes, and updates confidence model.
3.  **Batch Correction:** `amalfa untag --tag restricted-topic` (Scalable fix).

---

## Configuration (`.amalfa.yaml`)

```yaml
auto_augment:
  enabled: true
  on_save: true
  features:
    entity_linking: true
    clustering: true
    topic_modeling: true
  thresholds:
    linking: 0.85
    tagging: 0.60
```
