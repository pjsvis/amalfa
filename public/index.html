<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PolyVis | Structural Information Engineering</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/css/app.css" />
  <script src="/js/app.js" defer></script>
  <!-- Inline Theme Init -->
  <script>
    (() => {
      const stored = localStorage.getItem('polyvis-theme');
      if (stored) {
        document.documentElement.setAttribute('data-theme', stored);
      }
    })();
  </script>
  <script type="module" src="/js/utils/theme.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="home-layout" x-data="{ loaded: false, debug: false }" x-init="setTimeout(() => loaded = true, 50)"
  :class="{ 'loaded': loaded, 'layout-debug-mode': debug }" @keydown.window.shift.d="debug = !debug">
  
  <div class="app-shell">
    <!-- Navbar (Minimal) -->
    <header class="app-header">
        <nav class="nav-wrapper" style="display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; width: 100%;">
            <div style="display: flex; align-items: center; gap: 2rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <a href="/" class="nav-brand" style="font-weight: 900; font-size: 1.25rem; letter-spacing: -0.02em; text-decoration: none;">POLYVIS</a>
                    <span style="font-size: 10px; opacity: 0.5; font-family: var(--font-mono);">v2026.01</span>
                </div>
                
                <div class="nav-links" style="display: flex; gap: 1rem; white-space: nowrap;">
                    <a href="/" class="nav-item active">
                       <i data-lucide="home" style="width: 14px; height: 14px;"></i> HQ
                    </a>
                    <a href="/docs/" class="nav-item">
                       <i data-lucide="book-open" style="width: 14px; height: 14px;"></i> Docs
                    </a>
                    <a href="/sigma-explorer/" class="nav-item">
                       <i data-lucide="layout-dashboard" style="width: 14px; height: 14px;"></i> Graph
                    </a>
                </div>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="window.speechSynthesis.cancel()" class="nav-item" title="Silence Audio" style="background: none; border: none; cursor: pointer;">
                    <i data-lucide="volume-x" style="width: 14px; height: 14px;"></i>
                </button>
                <button onclick="window.toggleTheme()" class="nav-item" style="background: none; border: none; cursor: pointer;">
                    <i data-lucide="sun" style="width: 14px; height: 14px;"></i> Theme
                </button>
            </div>
        </nav>
    </header>

    <aside class="app-sidebar-left"></aside>

    <main class="app-main" style="overflow-y: auto; justify-content: flex-start;">
      <div class="container-dashboard" 
           x-data="{ 
              stats: { nodes: 0, edges: 0 }, 
              services: [], 
              runs: [],
              async load() {
                  try {
                      this.stats = await (await fetch('/api/stats')).json();
                      this.services = await (await fetch('/api/services')).json();
                      this.runs = await (await fetch('/api/runs')).json();
                  } catch (e) { console.error('Dashboard Load Error', e); }
              },
              async controlService(name, action) {
                  if(name === 'Dashboard' && (action === 'stop' || action === 'restart')) {
                      if(!confirm('Stopping the dashboard will kill this UI. Continue?')) return;
                  }
                  await fetch(`/api/services/${name}/${action}`, { method: 'POST' });
                  setTimeout(() => this.load(), 2000);
              }
           }" 
           x-init="load(); setInterval(load, 5000)"
           style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; width: 100%; max-width: 1400px; padding: 2rem; align-items: start;">
        
        <!-- CARD 1: IDENTITY & METRICS -->
        <div class="dashboard-card home-box" style="width: 100%; max-width: none; aspect-ratio: auto; border: 2px solid var(--ansi-white); padding: 24px; text-align: left; background-color: var(--surface-1);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                <div>
                    <h1 class="home-title" style="margin-bottom: 4px; font-size: 2rem;">POLYVIS</h1>
                    <div class="home-subtitle" style="font-size: 0.8rem;">Structural Information Engineering</div>
                </div>
                <div x-data="{ status: 'ONLINE', color: 'var(--ansi-green)' }" 
                     style="display: flex; align-items: center; gap: 6px; font-size: 10px; font-family: var(--font-mono); border: 1px solid var(--ansi-green); padding: 4px 8px; color: var(--ansi-green);">
                    <span class="status-dot" :style="`width: 6px; height: 6px; background-color: ${color}; border-radius: 50%;`"></span>
                    <span x-text="status" style="font-weight: bold;"></span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                <div style="border: 1px solid var(--ansi-white); padding: 12px;">
                    <div style="font-size: 32px; font-weight: bold; line-height: 1;" x-text="stats.nodes">0</div>
                    <div style="font-size: 10px; opacity: 0.7; letter-spacing: 1px; margin-top: 4px;">NODES</div>
                </div>
                <div style="border: 1px solid var(--ansi-white); padding: 12px;">
                    <div style="font-size: 32px; font-weight: bold; line-height: 1;" x-text="stats.edges">0</div>
                    <div style="font-size: 10px; opacity: 0.7; letter-spacing: 1px; margin-top: 4px;">EDGES</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                 <a href="/sigma-explorer/" class="btn-structural" style="flex: 1; justify-content: center; padding: 12px;">
                    <i data-lucide="layout-dashboard" style="width: 16px; height: 16px; margin-right: 8px;"></i> GRAPH
                 </a>
                 <a href="/docs/" class="btn-structural" style="flex: 1; justify-content: center; padding: 12px;">
                    <i data-lucide="book-open" style="width: 16px; height: 16px; margin-right: 8px;"></i> DOCS
                 </a>
            </div>
            
            <div style="margin-top: 24px; font-size: 10px; opacity: 0.5; font-family: var(--font-mono); border-top: 1px solid var(--border-dim); padding-top: 12px;">
                System Uptime: <span x-text="Math.floor(performance.now() / 1000) + 's'"></span>
            </div>
        </div>

        <!-- CARD 2: SERVICE HEALTH -->
        <div class="dashboard-card" style="border: 2px solid var(--ansi-white); padding: 24px; background-color: var(--surface-1);">
             <div class="text-xs font-bold uppercase tracking-widest mb-6 border-b border-[var(--border-dim)] pb-2">Service Status</div>
             
             <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">
                 <template x-for="service in services" :key="service.name">
                     <div class="p-4 border border-[var(--border-dim)] bg-[var(--surface-2)] flex flex-col gap-3 transition-colors hover:border-[var(--text-1)]"
                          style="min-height: 140px; justify-content: space-between;">
                         
                         <!-- Header -->
                         <div class="flex items-start justify-between">
                             <span class="font-mono text-xs font-bold leading-tight" x-text="service.name" style="max-width: 80%;"></span>
                             <div class="w-2 h-2 rounded-full shadow-[0_0_8px_currentColor] shrink-0" 
                                  :class="service.status === 'running' ? 'bg-green-500 text-green-500' : 'bg-red-500 text-red-500'"></div>
                         </div>

                         <!-- Status Details -->
                         <div class="text-xxs font-mono opacity-50 flex flex-col gap-1">
                             <div x-text="service.status.toUpperCase()" :class="service.status === 'running' ? 'text-green-500' : 'text-red-500'"></div>
                             <div x-text="service.pid ? 'PID: ' + service.pid : ''"></div>
                         </div>

                         <!-- Actions -->
                         <div class="grid grid-cols-2 gap-2 mt-auto">
                             <template x-if="service.status === 'running'">
                                <button @click="controlService(service.name, 'stop')" 
                                        class="text-xxs py-1.5 border border-red-500 text-red-500 hover:bg-red-500 hover:text-white uppercase transition-colors text-center">STOP</button>
                             </template>
                             <template x-if="service.status !== 'running'">
                                <button @click="controlService(service.name, 'start')" 
                                        class="text-xxs py-1.5 border border-green-500 text-green-500 hover:bg-green-500 hover:text-white uppercase transition-colors text-center">START</button>
                             </template>
                             <button @click="controlService(service.name, 'restart')" 
                                     class="text-xxs py-1.5 border border-[var(--text-2)] text-[var(--text-2)] hover:bg-[var(--text-2)] hover:text-black uppercase transition-colors text-center">RESET</button>
                         </div>
                     </div>
                 </template>
                 
                 <div x-show="services.length === 0" style="grid-column: 1 / -1;" class="flex flex-col items-center justify-center p-8 opacity-50">
                    <i data-lucide="server" class="w-8 h-8 mb-2"></i>
                    <span class="text-xs">Scanning services...</span>
                 </div>
             </div>
        </div>

        <!-- CARD 3: RECENT ACTIVITY (Full Width) -->
         <div class="dashboard-card" style="border: 2px solid var(--ansi-white); padding: 24px; grid-column: 1 / -1; background-color: var(--surface-1);">
             <div class="flex items-center justify-between mb-4 border-b border-[var(--border-dim)] pb-2">
                 <div class="text-xs font-bold uppercase tracking-widest">Ingestion Activity</div>
                 <div class="text-xs font-mono opacity-50">Last 5 Runs</div>
             </div>
             
             <div class="overflow-x-auto">
                 <table class="w-full text-left border-collapse text-xs font-mono">
                     <thead>
                         <tr class="text-[var(--text-2)] uppercase text-xxs tracking-wider">
                             <th class="py-3 px-2 border-b border-[var(--border-dim)]">Status</th>
                             <th class="py-3 px-2 border-b border-[var(--border-dim)]">Timestamp</th>
                             <th class="py-3 px-2 border-b border-[var(--border-dim)]">Files</th>
                             <th class="py-3 px-2 border-b border-[var(--border-dim)]">Duration</th>
                             <th class="py-3 px-2 border-b border-[var(--border-dim)]">Changes</th>
                         </tr>
                     </thead>
                     <tbody>
                         <template x-for="run in runs" :key="run.timestamp">
                             <tr class="border-b border-[var(--border-dim)] hover:bg-[var(--surface-2)] transition-colors">
                                 <td class="py-3 px-2">
                                     <span class="inline-flex items-center px-2 py-0.5 rounded text-xxs font-bold bg-green-900 text-green-100">SUCCESS</span>
                                 </td>
                                 <td class="py-3 px-2" x-text="new Date(run.timestamp).toLocaleString()"></td>
                                 <td class="py-3 px-2 font-bold" x-text="run.files"></td>
                                 <td class="py-3 px-2" x-text="run.duration + 'ms'"></td>
                                 <td class="py-3 px-2 opacity-70">Detecting...</td>
                             </tr>
                         </template>
                         <tr x-show="runs.length === 0">
                             <td colspan="5" class="py-8 text-center opacity-50 italic">
                                 No recent activity logged.
                             </td>
                         </tr>
                     </tbody>
                 </table>
             </div>
         </div>
      </div>
    </main>

    <aside class="app-sidebar-right"></aside>
    <footer class="app-footer"></footer>
  </div>
  
  <script>
    if (window.lucide) window.lucide.createIcons();
  </script>

  <script>
    // AGENT VISIBILITY HELPER
    window.__AGENT_THEME__ = (() => {
      const root = getComputedStyle(document.documentElement);
      const getVar = (name) => root.getPropertyValue(name).trim();

      return {
        system: "PolyVis Terminal Brutalist",
        palette: {
          canvas:    getVar('--ansi-black'),       
          text:      getVar('--ansi-white'),       
          highlight: getVar('--ansi-bright-white'),
          error:     getVar('--ansi-red'),         
          success:   getVar('--ansi-green'),       
          warning:   getVar('--ansi-yellow'),      
          agent:     getVar('--ansi-orange'),      
        },
        rules: {
          borderRadius: '0px', 
          fontFamily: getVar('--font-mono'),
          borders: '2px solid', 
        },
        interactive: {
          button: {
            description: "Hard inversion on hover. Instant transition.",
            default: { 
              bg: getVar('--ansi-black'), 
              text: getVar('--ansi-white'), 
              border: getVar('--ansi-white') 
            },
            hover: { 
              bg: getVar('--ansi-white'), 
              text: getVar('--ansi-black'), 
              border: getVar('--ansi-white') 
            }
          }
        }
      };
    })();
    console.log('%c[AGENT_THEME] System Visible', 'color: #FF8C00');
  </script>
</body>

</html>