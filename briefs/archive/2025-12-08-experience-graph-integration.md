# Plan: Experience Graph Integration (Sidecar Pipeline)

**Objective:** Populate `ctx.db` with resonance documents (Playbooks/Debriefs) and visualize them in Sigma Explorer, controlled by `polyvis.settings.json`.

## 1. Safety & Verification (First Step)
We will create a verification script to ensure we don't corrupt the existing Lexicon graph.
-   **Script:** `scripts/verify_graph_integrity.ts`
-   **Checks:**
    -   Snapshot node/edge counts of `scripts/ctx.db` before changes.
    -   Ensure standard Lexicon nodes (e.g. `OH-001`, `term-001`) exist.
    -   After ingestion, verify counts increased and specific connections (Debrief -> Protocol) exist.

## 2. Ingestion Logic (The Sidecar)
We will implement the "Sidecar" pattern as requested to avoid touching `build_db.ts`.
-   **Script:** `scripts/ingest_experience_graph.ts`
-   **Inputs:**
    -   `public/data/experience.json` ( Generated by `build_experience.ts`)
    -   `scripts/ctx.db` (The base Lexicon graph)
-   **Process:**
    1.  Read `polyvis.settings.json` for paths.
    2.  Open `scripts/ctx.db`.
    3.  Iterate through `experience.json`:
        -   **Insert Node**: `id`=Filename, `type`='debrief'|'playbook', `label`=Title, `definition`=Path.
        -   **Heuristic Edge Generation**:
            -   Read markdown content.
            -   Regex `OH-[0-9]{3}`, `PHI-[0-9]+`, `COG-[0-9]+` -> `CITES` edge to Protocol.
            -   Regex `[[wikilink]]` -> `REFERENCES` edge.
    4.  Copy updated `scripts/ctx.db` to `public/data/ctx.db`.

## 3. Visualization (Sigma Explorer)
We will update the UI to allow toggling this new layer.
-   **File:** `src/js/components/sigma-explorer.js` & `public/sigma-explorer/index.html`
-   **Changes:**
    -   **Load Phase**: Ensure `debrief` and `playbook` nodes are loaded but set `hidden: true` by default.
    -   **Control**: Add a "Show Experience" toggle in the sidebar.
    -   **Style**: Assign distinct colors/sizes for these new node types (e.g. Orange for Playbooks, Blue for Debriefs).

## 4. Execution Steps
1.  Create `scripts/verify_graph_integrity.ts`.
2.  Run Baseline Verification.
3.  Create `scripts/ingest_experience_graph.ts`.
4.  Run Ingestion.
5.  Run Post-Verification.
6.  Modify Sigma Explorer UI (`src/js/components/sigma-explorer.js`, `index.html`).
7.  Verify in Browser.

## 5. Configuration
All paths will be derived from `polyvis.settings.json`:
```json
{
  "paths": {
    "database": {
      "legacy": "scripts/ctx.db"
    },
    "sources": {
      "docs": ["playbooks/", "debriefs/"]
    }
  }
}
```
