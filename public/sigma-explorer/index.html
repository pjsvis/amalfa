<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark">
    <title>PolyVis | Layout Test</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Inline Theme Init to prevent FOUC -->
    <script>
        (() => {
            const stored = localStorage.getItem('polyvis-theme');
            if (stored) {
                document.documentElement.setAttribute('data-theme', stored);
            }
        })();
    </script>
    <script type="module" src="/js/utils/theme.js"></script>
    <script src="/js/app.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://unpkg.com/graphology@0.25.4/dist/graphology.umd.js"></script>
    <script src="https://unpkg.com/sigma@2.4.0/build/sigma.min.js"></script>
    <script src="https://unpkg.com/graphology-library@0.8.0/dist/graphology-library.min.js"></script>
    <link rel="stylesheet" href="/css/app.css" />
    <style>

    </style>
</head>

<!-- 
  STRICT FLEX LAYOUT SKELETON
  1. Body: Viewport Container
  2. Outer Flex: Navbar + Main
  3. Main Flex: Left + Graph + Right
-->

<body class="h-screen w-screen overflow-hidden text-sm antialiased"
    style="background-color: var(--surface-1); color: var(--text-1);" x-data="sigmaApp()"
    :class="{ 'loaded': loaded, 'layout-debug-mode': debug }" @keydown.window.shift.d="debug = !debug">



    <!-- Outer Flex Container (Vertical) -->
    <div class="flex h-full w-full flex-col">

        <!-- 1. Navbar (Fixed Height) -->
    <header class="app-header">
        <nav class="nav-wrapper" style="display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; width: 100%;">
            <div style="display: flex; align-items: center; gap: 2rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <a href="/" class="nav-brand" style="font-weight: 900; font-size: 1.25rem; letter-spacing: -0.02em; text-decoration: none;">POLYVIS</a>
                    <span style="font-size: 10px; opacity: 0.5; font-family: var(--font-mono);">v2026.01</span>
                </div>
                
                <div class="nav-links" style="display: flex; gap: 1rem; white-space: nowrap;">
                    <a href="/" class="nav-item">
                       <i data-lucide="home" style="width: 14px; height: 14px;"></i> HQ
                    </a>
                    <a href="/docs/" class="nav-item">
                       <i data-lucide="book-open" style="width: 14px; height: 14px;"></i> Docs
                    </a>
                    <a href="/sigma-explorer/" class="nav-item active">
                       <i data-lucide="layout-dashboard" style="width: 14px; height: 14px;"></i> Graph
                    </a>
                </div>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="window.speechSynthesis.cancel()" class="nav-item" title="Silence Audio" style="background: none; border: none; cursor: pointer;">
                    <i data-lucide="volume-x" style="width: 14px; height: 14px;"></i>
                </button>
                <button onclick="window.toggleTheme()" class="nav-item" style="background: none; border: none; cursor: pointer;">
                    <i data-lucide="sun" style="width: 14px; height: 14px;"></i> Theme
                </button>
            </div>
        </nav>
    </header>

        <!-- 2. Main Content (Fills remaining height) -->
        <div class="flex flex-row flex-nowrap flex-grow overflow-hidden relative">

            <!-- 2a. Left Sidebar (Fixed Width, Collapsible) -->
            <div x-show="leftOpen"
                class="explorer-sidebar-left flex-shrink-0 flex flex-col border-r shadow-sm transition-all z-20"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="-translate-x-full"
                x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full">
                <div class="flex items-center justify-between p-2 border-b"
                    style="background-color: var(--surface-1); border-color: var(--border-base);">
                    <span class="font-mono text-xs font-bold uppercase" style="color: var(--text-2);">Controls</span>
                    <button @click="leftOpen = false" class="">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Sidebar Content -->


                <div class="flex-grow overflow-y-auto p-4 space-y-4">
                    <!-- Analysis Group -->
                    <div>
                        <div class="mb-2 font-mono text-xxs font-bold uppercase" style="color: var(--text-2);">Analysis</div>
                        <div class="space-y-2">
                            <!-- Louvain -->
                            <div class="space-y-1">
                                <div class="group relative flex gap-1">
                                    <button class="w-full max-w-[220px]"
                                        :class="{ 'active': activeColorViz === 'louvain' }"
                                        @click="toggleColorViz('louvain')"
                                        :aria-pressed="activeColorViz === 'louvain'"
                                        @mouseenter="showTooltip($event, 'Detects communities (clusters) and colors nodes to show group membership.')"
                                        @mouseleave="hideTooltip()">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="users" class="h-3 w-3"></i> <span>Louvain Communities</span>
                                        </div>
                                        <div x-show="activeColorViz === 'louvain'" class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                                    </button>
                                </div>

                                <!-- Community List (Visible only when Louvain is active) -->
                                <!-- Community List (Visible only when Louvain is active) -->
                                <div x-show="activeColorViz === 'louvain'" x-transition class="mt-2 pl-1">
                                    <div class="flex w-full gap-1">
                                        <!-- Show All -->
                                        <button
                                            class="btn-square flex-1 aspect-square"
                                            :class="{ 'active': activeLouvainGroup === null }"
                                            @click="activeLouvainGroup = null; toggleColorViz('louvain', true)">
                                            ALL
                                        </button>

                                        <!-- Dynamic List -->
                                        <template x-for="(group, index) in getLouvainGroups()" :key="group.id">
                                            <button
                                                class="btn-square flex-1 aspect-square"
                                                :class="{ 'active': activeLouvainGroup === group.id }"
                                                :style="`background-color: ${group.color}; color: black;`"
                                                @click="activeLouvainGroup = group.id; toggleColorViz('louvain')"
                                                @mouseenter="showTooltip($event, group.name)"
                                                @mouseleave="hideTooltip()">
                                                <span x-text="String.fromCharCode(65 + index)"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- PageRank -->
                            <div class="group relative">
                                <button class=" w-full max-w-[220px]"
                                    :class="{ 'active': activeSizeViz === 'pagerank' }"
                                    @click="toggleSizeViz('pagerank')"
                                    :aria-pressed="activeSizeViz === 'pagerank'"
                                    @mouseenter="showTooltip($event, 'Sizes nodes based on their influence. Larger nodes are more \'important\'.')"
                                    @mouseleave="hideTooltip()">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="bar-chart-2" class="h-3 w-3"></i> <span>PageRank</span>
                                    </div>
                                    <div x-show="activeSizeViz === 'pagerank'" class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                                </button>
                            </div>

                            <!-- Degree -->
                            <div class="group relative">
                                <button class=" w-full max-w-[220px]"
                                    :class="{ 'active': activeSizeViz === 'degree' }"
                                    @click="toggleSizeViz('degree')"
                                    :aria-pressed="activeSizeViz === 'degree'"
                                    @mouseenter="showTooltip($event, 'Sizes nodes by connection count. Larger nodes have more direct connections.')"
                                    @mouseleave="hideTooltip()">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="circle" class="h-3 w-3"></i> <span>Degree</span>
                                    </div>
                                    <div x-show="activeSizeViz === 'degree'" class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                                </button>
                            </div>

                            <!-- Betweenness -->
                            <div class="group relative">
                                <button class="flex w-full max-w-[220px] items-center justify-between gap-2 rounded border border-transparent px-3 py-2 text-xs font-medium text-[var(--text-2)] transition-colors hover:bg-[var(--surface-hover)] hover:text-[var(--text-1)]"
                                    :class="{ 'bg-[var(--surface-2)] border-[var(--border-base)] font-bold text-[var(--primary)]': activeColorViz === 'betweenness' }"
                                    @click="toggleColorViz('betweenness')"
                                    :aria-pressed="activeColorViz === 'betweenness'"
                                    @mouseenter="showTooltip($event, 'Colors nodes based on \'bridging\' score. Redder nodes lie on more shortest paths.')"
                                    @mouseleave="hideTooltip()">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="git-commit" class="h-3 w-3"></i> <span>Betweenness</span>
                                    </div>
                                    <div x-show="activeColorViz === 'betweenness'" class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                                </button>
                            </div>

                            <!-- Components -->
                            <div class="group relative">
                                <button class="flex w-full max-w-[220px] items-center justify-between gap-2 rounded border border-transparent px-3 py-2 text-xs font-medium text-[var(--text-2)] transition-colors hover:bg-[var(--surface-hover)] hover:text-[var(--text-1)]"
                                    :class="{ 'bg-[var(--surface-2)] border-[var(--border-base)] font-bold text-[var(--primary)]': activeColorViz === 'components' }"
                                    @click="toggleColorViz('components')"
                                    :aria-pressed="activeColorViz === 'components'"
                                    @mouseenter="showTooltip($event, 'Highlights the largest connected group of nodes in Green.')"
                                    @mouseleave="hideTooltip()">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="share-2" class="h-3 w-3"></i> <span>Components</span>
                                    </div>
                                    <div x-show="activeColorViz === 'components'" class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Layers Group -->
                    
                    <!-- Sub-Graph Composer -->
                    <div>
                        <div class="mb-2 flex items-center justify-between font-mono text-xxs font-bold uppercase" style="color: var(--text-2);">
                            <span>Graph Composition</span>
                            <div class="flex gap-1">
                                <button @click="activeSubGraphs = []; constructGraph()"
                                    class="btn-small"
                                    title="Hide All">NONE</button>
                                <button @click="activeSubGraphs = [...availableSubGraphs]; constructGraph()"
                                    class="btn-small"
                                    title="Show All">ALL</button>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <!-- Dynamic List of Available Sub-Graphs -->
                            <template x-for="subGraph in availableSubGraphs" :key="subGraph">
                                <button class="w-full max-w-[220px]"
                                    :class="{ 'active': activeSubGraphs.includes(subGraph) }"
                                    @click="toggleSubGraph(subGraph)"
                                    @mouseenter="showTooltip($event, 'Toggle visibility of the ' + subGraph + ' graph layer.')"
                                    @mouseleave="hideTooltip()">
                                    
                                    <!-- Label -->
                                    <div class="flex items-center gap-2">
                                         <i data-lucide="folder" class="h-3 w-3 text-[var(--text-2)]"></i>
                                         <span class="capitalize" x-text="subGraph"></span>
                                    </div>

                                    <!-- LED Indicator -->
                                    <div class="h-2 w-2 rounded-full transition-all"
                                         :class="activeSubGraphs.includes(subGraph) ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-transparent border border-[var(--text-3)]'"></div>
                                </button>
                            </template>

                            <div x-show="availableSubGraphs.length === 0" class="text-xs text-gray-400 px-2 italic">
                                Exploring data...
                            </div>
                        </div>
                    </div>

                    <!-- Layout Group -->
                    <div>
                        <div class="mb-2 font-mono text-xxs font-bold uppercase" style="color: var(--text-2);">Layout</div>
                        <div class="group relative">
                            <select x-model="layout" @change="runLayout($event.target.value)"
                                class="flex w-full items-center justify-start gap-2 rounded border border-transparent px-3 py-2 text-xs font-medium text-[var(--text-2)] transition-colors hover:bg-[var(--surface-hover)] bg-transparent cursor-pointer"
                                style="-webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none;"
                                @mouseenter="showTooltip($event, 'Select an algorithm to automatically arrange the nodes.')"
                                @mouseleave="hideTooltip()">
                                <option value="forceatlas2">ForceAtlas2 (Physics)</option>
                                <option value="circular">Circular</option>
                                <option value="random">Random</option>
                                <option value="noverlap">Noverlap (De-clutter)</option>
                            </select>
                            <!-- Custom Arrow -->
                            <i data-lucide="chevron-down" class="absolute right-3 top-2.5 h-3 w-3 text-[var(--text-2)] pointer-events-none"></i>
                        </div>
                    </div>

                    <!-- Actions Group -->
                    <div>
                        <div class="mb-2 font-mono text-xxs font-bold uppercase" style="color: var(--text-2);">Actions</div>
                        <div class="space-y-1">
                            <button @click="toggleOrphans()"
                                class="w-full max-w-[220px]"
                                :class="{ 'active': showOrphans }"
                                :aria-pressed="showOrphans"
                                @mouseenter="showTooltip($event, 'Show/Hide nodes with no connections.')"
                                @mouseleave="hideTooltip()">
                                <div class="flex items-center gap-2">
                                    <i :data-lucide="showOrphans ? 'ghost' : 'ghost'" class="h-3 w-3"></i>
                                    <span x-text="showOrphans ? 'Hide Orphans' : 'Show Orphans'"></span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span x-show="orphanCount > 0" class="text-xxs opacity-70"
                                        x-text="'(' + orphanCount + ')'"></span>
                                    <div x-show="showOrphans" class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                                </div>
                            </button>
                            <button @click="toggleStats()"
                                class="w-full max-w-[220px]"
                                :class="{ 'active': showStats }"
                                :aria-pressed="showStats">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="info" class="h-3 w-3"></i> <span>Toggle Stats</span>
                                </div>
                                <div x-show="showStats" class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                            </button>
                        </div>
                    </div>

                    <!-- Help Group -->
                    <div class="pt-4 border-t border-gray-100">
                        <!-- Search Bar (Moved here) -->
                        <div class="mb-4 relative">
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-2 top-2.5 h-3 w-3" style="color: var(--text-2);"></i>
                                <input type="text" x-model="searchQuery" @input="handleSearch()"
                                    @focus="isSearchFocused = true; handleSearch()"
                                    @blur="setTimeout(() => isSearchFocused = false, 200)" placeholder="Search nodes..."
                                    style="background-color: var(--surface-1); color: var(--text-1); border-color: var(--border-base);"
                                    class="w-full pl-7 pr-2 py-1.5 text-xs border rounded focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors">
                            </div>

                            <!-- Search Results Dropdown (Downwards) -->
                            <div x-show="isSearchFocused && searchResults.length > 0"
                                style="background-color: var(--surface-panel); border-color: var(--border-base);"
                                class="absolute left-0 right-0 top-full mt-1 border rounded shadow-lg max-h-60 overflow-y-auto z-50"
                                x-transition.opacity>

                                <div x-show="!searchQuery"
                                    style="background-color: var(--surface-2); border-color: var(--border-base); color: var(--text-2);"
                                    class="px-2 py-1 text-xxs uppercase font-bold border-b">
                                    Suggested Concepts
                                </div>

                                <template x-for="node in searchResults" :key="node.id">
                                    <button @click="selectSearchResult(node.id)"
                                        class="btn-search w-full text-left">
                                        <span class="font-bold" style="color: var(--text-1);"
                                            x-text="node.label"></span>
                                        <span class="font-mono text-xxs" style="color: var(--text-2);"
                                            x-text="node.id"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <div class="mb-2 font-mono text-xxs font-bold uppercase" style="color: var(--text-2);">Help
                        </div>
                        <div class="text-xxs space-y-2 leading-relaxed font-mono" style="color: var(--text-1);">
                            <p>Push buttons to show graph features and click nodes to see details.</p>
                            <p>Use zoom controls to zoom and click & drag to move the graph.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2b. Graph Panel (Fills remaining width) -->
            <div class="explorer-graph-panel flex-grow relative overflow-hidden">

                <!-- Open Left Sidebar Button -->
                <button x-show="!leftOpen" @click="leftOpen = true"
                    class="btn-sidebar absolute left-0 top-4 z-10">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>

                <!-- Open Right Sidebar Button -->
                <button x-show="!rightOpen" @click="rightOpen = true"
                    class="btn-sidebar absolute right-0 top-4 z-10">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>

                <!-- Graph Container -->
                <!-- Graph Container -->
                <!-- Background handled by src/css/layers/graph.css (Isolated Layer) -->
                <div id="sigma-container" class="absolute inset-0 z-0" x-ref="sigmaContainer"></div>

                <!-- Floating Stats Panel (Bottom Left) -->
                <div x-show="showStats"
                    style="background-color: var(--surface-panel); border-color: var(--border-base); color: var(--text-1); min-width: var(--width-stats);"
                    class="absolute bottom-6 left-6 rounded-md border p-4 shadow-lg z-10 font-mono text-xs"
                    x-transition.opacity>
                    <div class="mb-2 border-b border-gray-200 pb-1 font-bold">Graph Statistics</div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                        <span class="text-gray-500">Nodes:</span> <span x-text="stats.nodes" class="font-bold"></span>
                        <span class="text-gray-500">Edges:</span> <span x-text="stats.edges" class="font-bold"></span>
                        <span class="text-gray-500">Density:</span> <span x-text="stats.density"
                            class="font-bold"></span>
                        <span class="text-gray-500">Avg Deg:</span> <span x-text="stats.avgDegree"
                            class="font-bold"></span>
                        <span class="text-gray-500">Orphans:</span> <span x-text="stats.orphans"
                            class="font-bold text-red-500" x-show="stats.orphans > 0"></span>
                        <span class="text-gray-500" x-show="stats.orphans === 0">Orphans:</span> <span x-text="stats.orphans"
                            class="font-bold text-gray-400" x-show="stats.orphans === 0"></span>
                    </div>

                    <!-- Health API Stats -->
                    <div x-show="health" class="mt-2 pt-2 border-t border-gray-200" x-transition>
                         <div class="mb-1 font-bold text-gray-700">Health Check</div>
                         <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                             <span class="text-gray-500">Giant Comp:</span>
                             <span x-text="health.giantCompPercent + '%'" class="font-bold" :class="health.giantCompPercent > 90 ? 'text-green-600' : 'text-amber-600'"></span>
                             <span class="text-gray-500">Islands:</span>
                             <span x-text="health.components - 1" class="font-bold" :class="health.components > 1 ? 'text-amber-600' : 'text-green-600'"></span>
                         </div>
                    </div>
                </div>

                <!-- Floating Zoom Controls (Top Right) -->
                <!-- Styling handled by src/css/layers/graph.css (Isolated Layer) -->
                <div class="sigma-zoom-controls absolute top-4 right-14 flex flex-col gap-2 rounded-md border p-2 z-10">
                    <button class="sigma-zoom-btn" @click="zoomIn()" title="Zoom In">
                        <i data-lucide="zoom-in" class="h-4 w-4"></i>
                    </button>
                    <button class="sigma-zoom-btn" @click="zoomReset()" title="Reset Camera">
                        <i data-lucide="maximize" class="h-4 w-4"></i>
                    </button>
                    <button class="sigma-zoom-btn" @click="zoomOut()" title="Zoom Out">
                        <i data-lucide="zoom-out" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>

            <!-- 2c. Right Sidebar (Fixed Width, Collapsible) -->
            <div x-show="rightOpen"
                class="explorer-sidebar-right flex-shrink-0 flex flex-col border-l shadow-sm transition-all z-20"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="translate-x-full"
                x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="translate-x-0" x-transition:leave-end="translate-x-full">
                <div style="background-color: var(--surface-1); border-color: var(--border-base);"
                    class="flex items-center justify-between p-2 border-b">
                    <button @click="rightOpen = false">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                    <span class="font-mono text-xs font-bold uppercase" style="color: var(--text-2);">Details</span>
                </div>

                <div class="flex-grow overflow-y-auto p-4 space-y-6">
                    <!-- Help Section (Collapsible) -->
                    <div>
                        <details x-ref="analysisGuide"
                            class="group open:bg-[var(--surface-2)] open:ring-1 open:ring-black/5 rounded-lg p-2 transition-all duration-300"
                            open>
                            <summary
                                class="flex items-center justify-between cursor-pointer list-none font-bold text-xs uppercase tracking-wider"
                                style="color: var(--text-1);">
                                <span>Analysis Guide</span>
                                <span class="transition group-open:rotate-180">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                            </summary>

                            <div class="text-xs space-y-2 leading-relaxed font-mono mt-2" style="color: var(--text-1);">
                                <p><strong>Welcome to the Knowledge Graph.</strong></p>
                                <p>This interactive map visualizes the relationships between key concepts.</p>
                                <ul class="list-disc pl-4 space-y-1">
                                    <li><strong>Nodes</strong> represent individual entities or concepts.</li>
                                    <li><strong>Lines</strong> show the connections between them.</li>
                                    <li><strong>Colors</strong> indicate communities or clusters of related topics.</li>
                                    <li><strong>Size</strong> reflects the importance or influence of a node within the
                                        network.</li>
                                </ul>
                                <p class="mt-2">Use the controls on the left to explore different perspectives and click
                                    on any node to dive deeper into its details.</p>
                            </div>
                        </details>
                    </div>

                    <!-- Node Details Section -->
                    <div x-show="selectedNode" 
                         x-effect="if (selectedNode) { $refs.analysisGuide?.removeAttribute('open') }"
                         class="space-y-4 border-t border-gray-100 pt-4"
                        x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-2"
                        x-transition:enter-end="opacity-100 translate-y-0">

                        <div class="flex items-center justify-between pb-2">
                            <div class="text-xs uppercase font-bold tracking-wider" style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">Node
                                Data</div>
                            <button @click="selectedNode = null" class="btn-close">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>

                        <template x-if="selectedNode">
                            <div class="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
                                <div>
                                    <div class="text-xxs uppercase font-bold tracking-wider mb-1"
                                        style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">
                                        Label
                                    </div>
                                    <div class="text-sm font-bold" style="color: var(--text-1);"
                                        x-text="selectedNode.label"></div>
                                </div>

                                <div>
                                    <div class="text-xxs uppercase font-bold tracking-wider mb-1"
                                        style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">Type
                                    </div>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                        style="background-color: var(--surface-3); color: var(--text-1);"
                                        x-text="selectedNode.nodeType"></span>
                                </div>

                                <div>
                                    <div class="text-xxs uppercase font-bold tracking-wider mb-1"
                                        style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">
                                        Definition
                                    </div>
                                    
                                    <!-- Collapsible Text Container -->
                                    <div x-data="{ expanded: false, isLong: false }" 
                                         x-effect="
                                             if (selectedNode) {
                                                // Reset state on node change
                                                expanded = false;
                                                // Yield to let x-html render
                                                setTimeout(() => {
                                                     isLong = $refs.content.scrollHeight > 80; // approx 4 lines
                                                }, 50);
                                             }
                                         ">
                                        
                                        <div x-ref="content" 
                                             class="text-xs leading-relaxed font-mono transition-all duration-300 overflow-hidden" 
                                             style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y)))); display: -webkit-box; -webkit-box-orient: vertical;"
                                             :style="expanded ? 'display: block;' : '-webkit-line-clamp: 4 !important; display: -webkit-box !important;'"
                                             x-html="linkify(selectedNode.definition || 'No definition available.')"
                                             @click="handleContentClick($event)">
                                        </div>

                                        <button x-show="isLong"
                                                @click="expanded = !expanded"
                                                class="btn-text mt-1"
                                                x-text="expanded ? 'Show Less' : 'Show More...'">
                                        </button>
                                    </div>
                                </div>

                                <div class="pt-4 border-t" style="border-color: var(--border-base);">
                                    <!-- Find Similar (Ghost Graph) -->
                                    <button @click="findSimilar(selectedNode.id)"
                                            class="btn-ghost w-full mb-4"
                                            aria-label="Find Similar Nodes">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i>
                                        FIND SIMILAR
                                    </button>

                                    <!-- Similar Nodes List -->
                                    <div x-show="similarNodes.length > 0" class="mb-4 space-y-1">
                                        <div class="text-xxs uppercase font-bold tracking-wider mb-1" style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">Similar Concepts</div>
                                        <template x-for="sim in similarNodes" :key="sim.id">
                                            <button @click="selectNode(sim.id); runLayout('forceatlas2')"
                                                    class="btn-similar w-full text-left">
                                                <div class="flex items-center gap-2 truncate">
                                                     <div class="w-1.5 h-1.5 rounded-full" style="background-color: var(--color-ghost-edge);"></div>
                                                     <span class="truncate font-mono" style="color: var(--text-1);" x-text="sim.label"></span>
                                                </div>
                                                <span class="text-xxs font-bold opacity-60" style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));" x-text="sim.score"></span>
                                            </button>
                                        </template>
                                    </div>
                                    
                                    <!-- Empty State Message -->
                                    <div x-show="searchComplete && !hasSimilarNodes" 
                                         class="mb-4 text-xs italic text-center p-2 rounded" 
                                         style="background-color: var(--surface-3); color: color(from var(--surface-3) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">
                                        No similar concepts found.
                                    </div>

                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div>
                                            <span style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">Degree:</span>
                                            <span class="font-mono ml-1"
                                                x-text="graph ? graph.degree(selectedNode.id) : 0"></span>
                                        </div>
                                        <div>
                                            <span style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">ID:</span>
                                            <span class="font-mono ml-1 truncate" x-text="selectedNode.id"></span>
                                        </div>
                                    </div>
                                </div>


                            <!-- External References -->
                            <template x-if="selectedNode.external_refs && selectedNode.external_refs.length > 0">
                                <div class="pt-4 border-t" style="border-color: var(--border-base);">
                                    <div class="text-xxs uppercase font-bold tracking-wider mb-2"
                                        style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));">
                                        External References</div>
                                    <div class="space-y-2">
                                        <template x-for="ref in selectedNode.external_refs" :key="ref.url">
                                            <a :href="ref.url" target="_blank" style="border-color: var(--border-base);"
                                                class="flex items-center justify-between p-2 rounded border hover:bg-[var(--surface-3)] transition-colors group">
                                                <div class="flex items-center gap-2">
                                                    <i data-lucide="external-link" class="w-3 h-3"
                                                        style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));"></i>
                                                    <span class="text-xs font-mono" style="color: color(from var(--surface-1) xyz round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))) round(up, min(1, max(0, 0.18 - y))));"
                                                        x-text="ref.label"></span>
                                                </div>
                                                <span class="text-xxs uppercase px-1.5 py-0.5 rounded"
                                                    style="background-color: var(--surface-3); color: var(--text-2);"
                                                    x-text="ref.type"></span>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </template>
                    </div>
                    </template>

                </div>
            </div>
        </div>

    </div>

    </div>



    <div x-show="tooltip.visible" x-transition.opacity
        class="fixed p-2 text-xs font-bold rounded shadow-xl pointer-events-none max-w-xs bg-white text-black border border-gray-300"
        :style="`top: ${tooltip.y}px; left: ${tooltip.x}px; z-index: var(--z-tooltip);`" x-text="tooltip.text">
    </div>
    <script>
        // Initialize Lucide Icons
        if (window.lucide) {
            window.lucide.createIcons();
        }
    </script>
</body>

</html>